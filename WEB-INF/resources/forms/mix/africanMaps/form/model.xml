<?xml version="1.0" encoding="UTF-8"?>
<!--
    Copyright (C) 2008 Orbeon, Inc.

    This program is free software; you can redistribute it and/or modify it under the terms of the
    GNU Lesser General Public License as published by the Free Software Foundation; either version
    2.1 of the License, or (at your option) any later version.

    This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY;
    without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.
    See the GNU Lesser General Public License for more details.

    The full text of the license is available at http://www.gnu.org/copyleft/lesser.html
-->
<xforms:model xmlns:xhtml="http://www.w3.org/1999/xhtml"
      xmlns:xforms="http://www.w3.org/2002/xforms"
      xmlns:xs="http://www.w3.org/2001/XMLSchema"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xmlns:ev="http://www.w3.org/2001/xml-events"
      xmlns:xi="http://www.w3.org/2001/XInclude"
      xmlns:xxi="http://orbeon.org/oxf/xml/xinclude"
      xmlns:xxforms="http://orbeon.org/oxf/xml/xforms"
      xmlns:fr="http://orbeon.org/oxf/xml/form-runner"
      xmlns:fb="http://orbeon.org/oxf/xml/form-builder"
      xmlns:saxon="http://saxon.sf.net/"
      xmlns:xbl="http://www.w3.org/ns/xbl"

      id="fr-form-model">

    <xforms:action ev:event="xforms-model-construct-done">

        <!-- Handle user agent -->

        <xxforms:variable name="user-agent" select="xxforms:get-request-header('user-agent')"/>
        <xforms:setvalue ref="instance('fb-user-agent-instance')/value" value="$user-agent"/>
        <!-- IE detection -->
        <xxforms:variable name="is-ie" select="contains(lower-case($user-agent), 'msie') and not(contains(lower-case($user-agent), 'opera'))"/>
        <xforms:setvalue ref="instance('fb-user-agent-instance')/is-ie" value="$is-ie"/>
        <!-- Try to find IE version -->
        <xforms:action if="$is-ie">
            <xxforms:variable name="msie" select="(for $t in tokenize(lower-case($user-agent), '[;\(\)]') return normalize-space($t))[starts-with(., 'msie')][1]"/>
            <xxforms:variable name="ie-version" select="xs:integer(substring-before(normalize-space(substring-after($msie, 'msie')), '.'))"/>
            <xforms:setvalue ref="instance('fb-user-agent-instance')/ie-version" value="$ie-version"/>
            <xforms:setvalue ref="instance('fb-user-agent-instance')/is-supported-ie" value="$ie-version = (7, 8)"/>
        </xforms:action>

        <!-- Load components -->
        <xforms:send submission="fb-load-components"/>
    </xforms:action>

    <!-- Variable pointing to the current language -->
    <xxforms:variable name="fb-lang" select="instance('fb-language-instance')"/>

    <!-- Other variables -->
    <xxforms:variable name="model" select="xhtml:head/xforms:model[@id = 'fr-form-model']"/>
    <xxforms:variable name="form-instance" select="$model/xforms:instance[@id = 'fr-form-instance']/*"/>
    <xxforms:variable name="metadata-instance" select="$model/xforms:instance[@id = 'fr-form-metadata']/*"/>
    <xxforms:variable name="resources" select="$model/xforms:instance[@id = 'fr-form-resources']/*"/>
    <xxforms:variable name="current-resources" select="$resources/resource[@xml:lang = $fb-lang]"/>
    <xxforms:variable name="body" select="xhtml:body/fr:view/fr:body"/>

    <xxforms:variable name="current-top-level-block" select="$body/fr:*[index('fb-top-level-repeat')]"/>
    <xxforms:variable name="current-section-content-block" select="$current-top-level-block/fr:*[index('fb-section-content-repeat')]"/>
    <xxforms:variable name="current-td" select="$current-section-content-block/
                                        xhtml:tr[index('fb-section-content-grid-tr-repeat')]/
                                        xhtml:td[index('fb-section-content-grid-td-repeat')]"/>

    <!-- Main instance -->
    <xforms:instance id="fr-form-instance" src="oxf:/forms/orbeon/builder/form/template.xml"/>

    <!-- Binds on main instance -->
    <xforms:bind nodeset=".">
        <!-- Form metadata (also used by Form Runner) -->
        <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-metadata']/*">
            <xforms:bind id="application-name-bind" nodeset="application-name" required="true()" type="xs:NCName" readonly="false()"/>
            <xforms:bind id="form-name-bind" nodeset="form-name" required="true()" type="xs:NCName" readonly="false()"/>
            <xforms:bind id="title-bind" nodeset="title[@xml:lang = $fb-lang]" required="true()"/>
            <xforms:bind id="description-bind" nodeset="description[@xml:lang = $fb-lang]"/>
            <xforms:bind id="logo-bind" nodeset="logo" type="xs:anyURI"/>
        </xforms:bind>
        <!-- Global attachments (also used by Form Runner) -->
        <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-attachments']/*">
            <xforms:bind id="css-attachment-bind" nodeset="css" type="xs:anyURI"/>
            <xforms:bind id="pdf-attachment-bind" nodeset="pdf" type="xs:anyURI"/>
        </xforms:bind>
        <!-- Form instance -->
        <xforms:bind nodeset="xhtml:head/xforms:model[@id = 'fr-form-model']/xforms:instance[@id = 'fr-form-instance']/*">

            <!-- Handle date / time types. Note we make them optional with xforms:* so we can save the form -->
            <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'date']/@nodeset]" type="xforms:date"/>
            <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'time']/@nodeset]" type="xforms:time"/>
            <xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'dateTime']/@nodeset]" type="xforms:dateTime"/>
            <!-- Handle "boolean" type -->
            <!--<xforms:bind nodeset="*/*[name() = $model/xforms:bind/xforms:bind/xforms:bind[substring-after(@type, ':') = 'boolean']/@nodeset]" type="xs:boolean"/>-->

            <!-- Handle local attachments -->
            <xforms:bind nodeset="*/*[@filename and @mediatype and @size]" type="xs:anyURI" class="fr-attachment"/>
        </xforms:bind>
        <!-- Set HTML title -->
        <xforms:bind nodeset="xhtml:head/xhtml:title" calculate="$metadata-instance/title"/>
    </xforms:bind>

    <!-- Metadata -->
    <xforms:instance id="fr-form-metadata" xxforms:readonly="true">
        <metadata>
            <application-name>orbeon</application-name>
            <form-name>builder</form-name>
            <title xml:lang="en">Orbeon Form Builder</title>
            <description xml:lang="en">Orbeon Form Builder allows you to easily build forms right from your web browser and without programming.</description>
            <title xml:lang="fr">Orbeon Form Builder</title>
            <description xml:lang="fr">Orbeon Form Builder vous permet d'éditer des formulaires directement depuis votre navigateur et sans programmation.</description>
            <author>Orbeon, Inc.</author>
            <logo mediatype="image/png" filename="orbeon-logo-trimmed-transparent-42.png" size="">/apps/fr/style/orbeon-logo-trimmed-transparent-42.png</logo>
        </metadata>
    </xforms:instance>

    <!-- All form resources -->
    <xforms:instance id="fr-form-resources" xxforms:readonly="true">
        <resources>
            <resource xml:lang="en">
                <application-name>
                    <label>Application Name</label>
                    <hint>click to add</hint>
                    <alert>Must be non-empty and contain no blanks</alert>
                </application-name>
                <form-name>
                    <label>Form Name</label>
                    <hint>click to add</hint>
                    <alert>Must be non-empty and contain no blanks</alert>
                </form-name>
                <title>
                    <label>Form Title</label>
                    <hint>click to enter a form title</hint>
                    <alert>The form title is required</alert>
                </title>
                <description>
                    <label>Form Description</label>
                    <hint>click to enter an optional form description</hint>
                </description>
                <logo>
                    <label>Logo</label>
                    <hint>The logo appears at the top of your form</hint>
                </logo>
                <!-- TODO: i18n whole Form Builder -->
            </resource>
            <resource xml:lang="fr">
                <application-name>
                    <label>Nom de l'application</label>
                    <hint>Veuillez entrer un nom d'application</hint>
                    <alert>Le nom de l'application doit être un identifiant non vide</alert>
                </application-name>
                <form-name>
                    <label>Nom du formulaire</label>
                    <hint>Veuillez entrer un nom de formulaire</hint>
                    <alert>Le nom du formulaire doit être un identifiant non vide</alert>
                </form-name>
                <title>
                    <label>Titre du formulaire</label>
                    <hint>Veuillez entrer un titre de formulaire</hint>
                    <alert>Le titre de formulaire est requis</alert>
                </title>
                <description>
                    <label>Description du formulaire</label>
                    <hint>Veuillez entrer une description du formulaire</hint>
                </description>
                <logo>
                    <label>Logo</label>
                    <hint>Le logo apparaît au sommet de votre formulaire</hint>
                </logo>
            </resource>
        </resources>
    </xforms:instance>

    <!-- Instance containing the current language -->
    <xforms:instance id="fb-language-instance">
        <language>en</language>
    </xforms:instance>

    <!-- Temporary instance for grid computations -->
    <xforms:instance id="fb-span-grid-instance">
        <grid/>
    </xforms:instance>

    <!-- Prepare span grid -->
    <xforms:action ev:event="fb-prepare-span-grid">
        <xxforms:variable name="grid" select="event('grid')"/>

        <!-- Prepare span grid -->
        <xxforms:variable name="tmp" select="instance('fb-span-grid-instance')"/>
        <xforms:delete xxforms:iterate="instance('fb-span-grid-instance')/*" nodeset="."/>
        <xforms:insert context="instance('fb-span-grid-instance')" nodeset="*"
                       origin="for $r in $grid/xhtml:tr return xxforms:element('r', for $c in (1 to $grid/@columns) return xxforms:element('c'))"/>

        <!-- Fill-out table with rowspan / colspan data -->
        <xforms:action xxforms:iterate="instance('fb-span-grid-instance')/*"><!-- Iterating over rows -->
            <xxforms:variable name="r" select="."/>
            <xxforms:variable name="y" select="position()"/>

            <xforms:action xxforms:iterate="$grid/xhtml:tr[$y]/xhtml:td"><!-- Iterating over actual tds -->
                <xxforms:variable name="td" select="."/>
                <xxforms:variable name="td-x" select="position()"/>
                <xxforms:variable name="rowspan" select="if (@rowspan) then xs:integer(@rowspan) else 1"/>

                <xxforms:variable name="c" select="($r/c[. != 'x'])[$td-x]"/>
                <xxforms:variable name="x" select="count($c/preceding-sibling::c) + 1"/>

                <xforms:action xxforms:iterate="$r/following-sibling::r[position() lt $rowspan]">
                    <xforms:setvalue ref="c[$x]">x</xforms:setvalue>
                </xforms:action>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- Store user-agent details -->
    <xforms:instance id="fb-user-agent-instance">
        <user-agent>
            <value/>
            <is-ie/>
            <ie-version/>
            <is-supported-ie/>
        </user-agent>
    </xforms:instance>

    <!-- Submission to test the form -->
    <xforms:submission id="fb-test-form-submission"
            ref="instance('fr-form-instance')" method="post" replace="all"
            resource="/fr/orbeon/builder/test" xxforms:target="_blank" xxforms:show-progress="false"/>

    <!-- TODO: check where local variable can be used instead -->
    <xforms:instance id="fb-variables">
        <variables>
            <done/>

            <!-- Currently open in-place editor -->
            <inplace-id/>
            <inplace-repeat-indexes/>

            <next-section-id/>
            <next-control-id/>

            <new-language/>
            <new-language-trigger/>

            <publish-trigger/>
            <controls-triggers/>

            <xml-view/>
        </variables>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-variables')">
        <!-- Publish is enabled only when the data is clean -->
        <xforms:bind nodeset="publish-trigger" readonly="xxforms:instance('fr-form-valid-instance') = 'false'"/>
        <!-- When are toolbar controls triggers enabled -->
        <xforms:bind nodeset="controls-triggers"
                     readonly="$current-td/* and not($current-td/following-sibling::xhtml:td[1][not(*)]
                                                            or not($current-td/following-sibling::xhtml:td)
                                                                    and (not(exists($current-td/../following-sibling::xhtml:tr[1]/xhtml:td[1]/*)))
                                                        )"/>
    </xforms:bind>

    <!-- React to a focus on a repeat -->
    <xforms:action ev:event="DOMFocusIn" ev:target="fb-section-content-grid-td-repeat">
        <!-- TODO: anything here? -->
    </xforms:action>

    <!-- Ensure there is an empty xhtml:td to place a new control (may fail) -->
    <xforms:action ev:event="fb-ensure-empty-td">

        <xforms:action context="$current-td">
            <xforms:action if="not(exists(*))">
                <!-- There is no  element in the current td, don't change anything -->
            </xforms:action>
            <xforms:action if="exists(*)">
                <!-- There is an element in the current td, figure out what to do -->
                <xxforms:variable name="is-next-td-available" select="following-sibling::xhtml:td[1][not(*)]"/>
                <xforms:action if="$is-next-td-available">
                    <!-- Next cell is empty, move to that one -->
                    <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="index('fb-section-content-grid-td-repeat') + 1"/>
                </xforms:action>
                <xforms:action if="not($is-next-td-available) and following-sibling::xhtml:td">
                    <!-- TODO: Not sure we have a plan here -->
                </xforms:action>
                <xforms:action if="not($is-next-td-available) and not(following-sibling::xhtml:td)">
                    <xxforms:variable name="is-insert-new-row"
                                      select="exists(../following-sibling::xhtml:tr[1]/xhtml:td[1]/*) or not(exists(../following-sibling::xhtml:tr[1]))"/>
                    <!-- We are the last cell of the row -->
                    <xforms:action if="$is-insert-new-row">
                        <!-- The first cell of the next row is occupied, or there is no next row: insert new row -->
                        <xforms:dispatch name="DOMActivate" target="fb-insert-row-below-trigger"/>
                        <!-- Make sure the first cell is selected -->
                        <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                    </xforms:action>
                    <xforms:action if="not($is-insert-new-row)">
                        <!-- There is a next row, and its first cell is empty, move to that one -->
                        <xforms:setindex repeat="fb-section-content-grid-tr-repeat" index="index('fb-section-content-grid-tr-repeat') + 1"/>
                        <xforms:setindex repeat="fb-section-content-grid-td-repeat" index="1"/>
                    </xforms:action>
                </xforms:action>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- Delete control and associated resources -->
    <xforms:action ev:event="fb-delete-control">
        <xxforms:variable name="control" select="event('control')"/>

        <xxforms:variable name="control-name" select="substring-before($control/@id, '-control')"/>
        <xxforms:variable name="section-name" select="$control/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind'))"/>
        <xxforms:variable name="bind" select="$model/xforms:bind[@id = 'fr-form-binds']/xforms:bind[@nodeset = $section-name]/xforms:bind[@nodeset = $control-name]"/>

        <!-- Delete control -->
        <xforms:delete nodeset="$control"/>
        <!-- Delete instance holder -->
        <xforms:delete nodeset="$form-instance/*[name() = $section-name]/*[name() = $control-name]"/>
        <!-- Delete resources -->
        <xforms:delete xxforms:iterate="$resources/resource/*[name() = $control-name]" nodeset="."/>
        <!-- Delete bind if any -->
        <xforms:delete nodeset="$bind"/>
    </xforms:action>

    <!-- Insert instance and resource holders -->
    <xforms:action ev:event="fb-insert-holders">
        <xxforms:variable name="current-td" select="event('current-td')"/>
        <xxforms:variable name="section-name" select="event('section-name')"/>
        <xxforms:variable name="instance-holder" select="event('instance-holder')"/>
        <xxforms:variable name="resource-holders" select="event('resource-holders')"/>

        <!-- All the xhtml:td elements up to and including the current one -->
        <xxforms:variable name="tds" select="($current-td/../preceding-sibling::xhtml:tr/xhtml:td, $current-td/preceding-sibling::xhtml:td)"/>

        <!-- Name of the preceding control id -->
        <xxforms:variable name="preceding-control-id" select="substring-before(($tds/*)[last()]/@id, '-control')"/>

        <!--<xforms:message>-->
            <!--Preceding: <xforms:output value="$preceding-control-id"/>-->
        <!--</xforms:message>-->

        <!-- Insert new holder element into the instance just after the previous control -->
        <xforms:insert context="$form-instance/*[name() = $section-name]"
                       nodeset="*[name() = $preceding-control-id]"
                       origin="$instance-holder"/>

        <!-- Insert resources placeholders for all languages -->
        <xforms:action xxforms:iterate="$resources/resource">
            <xxforms:variable name="position" select="position()"/>
            <xforms:insert context="." nodeset="*[name() = $preceding-control-id]" origin="$resource-holders[$position]"/>

            <!-- Insert resource templates only if holder passed is not empty -->
            <xforms:insert context="*[name() = name($resource-holders[$position])]" if="not(*)" origin="instance('fb-resource-template')/*"/>
        </xforms:action>
    </xforms:action>

    <!-- Cut/copy/paste instance -->
    <xforms:instance id="fb-xcv-instance">
        <xcv>
            <control/>
            <holder/>
            <resources/>
            <bind/>
            <cut-trigger/>
            <copy-trigger/>
            <paste-trigger/>
        </xcv>
    </xforms:instance>
    <xxforms:variable name="xcv" select="instance('fb-xcv-instance')"/>

    <xforms:bind nodeset="$xcv">
        <xforms:bind nodeset="cut-trigger" readonly="not(exists($current-td/*))"/>
        <xforms:bind nodeset="copy-trigger" readonly="not(exists($current-td/*))"/>
        <xforms:bind nodeset="paste-trigger" readonly="not(exists(../control/*))"/>
    </xforms:bind>

    <!-- Copy current control to xcv instance -->
    <xforms:action ev:event="fb-copy-control">
        <xxforms:variable name="current-control" select="event('current-td')/*"/>

        <xforms:action if="exists($current-control)">
            <xxforms:variable name="current-control-name" select="substring-before($current-control/@id, '-control')"/>
            <xxforms:variable name="current-bind-id" select="concat($current-control-name, '-bind')"/>
            <xxforms:variable name="bind" select="$model//xforms:bind[@id = $current-bind-id]"/>

            <!-- Clear clipboard -->
            <xforms:action xxforms:iterate="$xcv/*">
                <xforms:delete while="*" nodeset="*"/>
            </xforms:action>

            <!-- Copy control -->
            <xforms:insert context="$xcv/control" origin="$current-control"/>

            <!-- Copy holder -->
            <xforms:insert context="$xcv/holder" origin="$form-instance/*/*[name() = $current-control-name]"/>

            <!-- Copy all resources -->
            <xforms:insert context="$xcv/resources" origin="$resources/resource/*[name() = $current-control-name]"/>

            <!-- Copy bind if any -->
            <xforms:insert context="$xcv/bind" origin="$bind"/>
        </xforms:action>

    </xforms:action>

    <!-- Adjust control bindings -->
    <xforms:action ev:event="fb-rename-control">
        <xxforms:variable name="control" select="event('control')"/>
        <xxforms:variable name="new-control-name" select="event('new-name')"/>

        <xforms:action context="$control">
            <!-- Set @id in any case -->
            <xforms:insert context="." origin="xxforms:attribute('id', concat($new-control-name, '-control'))"/>

            <!-- Set @ref value if present -->
            <xforms:setvalue ref="@ref" value="$new-control-name"/>

            <!-- Set @bind value if present -->
            <xforms:setvalue ref="@bind" value="concat($new-control-name, '-bind')"/>

            <!-- Set xforms:label, xforms:hint, xforms:help and xforms:alert @ref if present -->
            <xforms:action xxforms:iterate="(xforms:label, xforms:hint, xforms:help, xforms:alert)[@ref = '' or starts-with(@ref, '$form-resources')]">
                <xxforms:variable name="local-name" select="local-name()"/>
                <xforms:setvalue ref="@ref" value="concat('$form-resources/', $new-control-name, '/', $local-name)"/>
            </xforms:action>

            <!-- Set xforms:itemset/@nodeset value if present -->
            <xforms:setvalue ref="xforms:itemset/@nodeset" value="concat('$form-resources/', $new-control-name, '/item')"/>
        </xforms:action>
    </xforms:action>

    <!-- Rename holders -->
    <xforms:action ev:event="fb-rename-holders">
        <xxforms:variable name="holders" select="event('holders')"/>
        <xxforms:variable name="new-name" select="event('new-name')"/>

        <!-- Iterate through instance holder and all resources -->
        <xforms:action xxforms:iterate="$holders">
            <xxforms:variable name="current-holder" select="."/>

            <!-- Insert new placeholder after existing one -->
            <xforms:insert nodeset="$current-holder" origin="xxforms:element($new-name)"/>
            <!-- Copy existing content into new element -->
            <xforms:insert context="$current-holder/following-sibling::*[1]" origin="$current-holder/(@* | node())"/>
            <!-- Delete old element -->
            <xforms:delete nodeset="$current-holder"/>
        </xforms:action>
    </xforms:action>

    <!-- Rename bind -->
    <xforms:action ev:event="fb-rename-bind">
        <xxforms:variable name="old-bind-id" select="concat(event('old-name'), '-bind')"/>
        <xxforms:variable name="bind" select="$model//xforms:bind[@id = $old-bind-id]"/>
        <xforms:action context="$bind" if="exists(.)">
            <xforms:setvalue ref="@id" value="concat(event('new-name'), '-bind')"/>
            <xforms:insert context="." origin="xxforms:attribute('name', event('new-name'))"/>
            <xforms:setvalue ref="@nodeset" value="event('new-name')"/>
        </xforms:action>
    </xforms:action>

    <!-- Paste control if there is one in the clipboard -->
    <xforms:action ev:event="fb-paste-control" if="$xcv/control/*">

        <!-- Try to find empty td -->
        <xforms:dispatch name="fb-ensure-empty-td" target="fr-form-model"/>

        <!-- Get new td -->
        <xxforms:variable name="new-td" select="$current-section-content-block/
            xhtml:tr[index('fb-section-content-grid-tr-repeat')]/
            xhtml:td[index('fb-section-content-grid-td-repeat')]"/>
        <xforms:action context="$new-td" if="not(exists(*))">
            <!-- We now have an empty cell for pasting -->

            <xxforms:variable name="xcv-control-id" select="$xcv/control/*/@id"/>

            <!-- Check if clipboard control id is in use -->
            <xforms:action if="$body//*[@id = $xcv-control-id]">
                <!-- If so, get new id and replace references -->
                <xforms:dispatch name="fb-compute-control-id" target="fr-form-model"/>
                <xxforms:variable name="new-control-name" select="concat('control-', $next-control-id)"/>

                <!-- Adjust bindings on xcv control -->
                <xforms:dispatch name="fb-rename-control" target="fr-form-model">
                    <xxforms:context name="control" select="$xcv/control/*"/>
                    <xxforms:context name="new-name" select="$new-control-name"/>
                </xforms:dispatch>

                <!-- Rename holders -->
                <xforms:dispatch name="fb-rename-holders" target="fr-form-model">
                    <xxforms:context name="holders" select="($xcv/holder/*, $xcv/resources/*)"/>
                    <xxforms:context name="new-name" select="$new-control-name"/>
                </xforms:dispatch>

                <!-- Update bind if existing -->
                <xforms:setvalue ref="$xcv/bind/xforms:bind/@id" value="concat($new-control-name, '-bind')"/>
                <xforms:setvalue ref="$xcv/bind/xforms:bind/@nodeset" value="$new-control-name"/>

            </xforms:action>

            <!-- Insert control -->
            <xforms:insert context="$new-td" origin="$xcv/control/*"/>

            <!-- Insert instance and resource holders -->
            <!-- TODO: match against existing languages, as that may have changed between copy and paste -->
            <xxforms:variable name="section-name" select="$current-td/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind'))"/>
            <xforms:dispatch name="fb-insert-holders" target="fr-form-model">
                <xxforms:context name="current-td" select="$new-td"/>
                <xxforms:context name="section-name" select="$section-name"/>
                <xxforms:context name="instance-holder" select="$xcv/holder/*"/>
                <xxforms:context name="resource-holders" select="$xcv/resources/*"/>
            </xforms:dispatch>

            <!-- Insert bind if any -->
            <xforms:action if="exists($xcv/bind/xforms:bind)">
                <xxforms:variable name="control-name" select="substring-before($xcv/control/*/@id, '-control')"/>
                <xforms:dispatch name="fb-ensure-bind" target="fr-form-model">
                    <xxforms:context name="control-name" select="$control-name"/>
                </xforms:dispatch>
                <xxforms:variable name="bind" select="$model//xforms:bind[@nodeset = $control-name]"/>
                <xforms:insert nodeset="$bind" origin="$xcv/bind/xforms:bind"/>
                <xforms:delete nodeset="$bind"/>
            </xforms:action>

        </xforms:action>
    </xforms:action>

    <!-- Generic instance to set the control id on which to work -->
    <!-- NOTE: Ideally we wouldn't need this kind of global variables, but could either call functions or pass parameters to events -->
    <xforms:instance id="fb-current-control-instance">
        <control>
            <id/>
        </control>
    </xforms:instance>
    <xxforms:variable name="current-control-name" select="instance('fb-current-control-instance')/id"/>

    <!-- Create the bind element for the current control or section if it does not exist yet -->
    <xforms:action ev:event="fb-ensure-bind">
        <!-- Control name -->
        <xxforms:variable name="control-name" select="event('control-name')"/>
        <!-- Use this if you don't pass a control name and just want to create the bind for the section -->
        <xxforms:variable name="section-name" select="event('section-name')"/>

        <!-- Insert bind container if needed -->
        <xforms:insert context="$model"
                       if="not(xforms:bind[@id = 'fr-form-binds'])"
                       nodeset="xforms:instance[@id = 'fr-form-instance']"
                       origin="instance('fb-bind-template')"/>

        <!-- Insert bind for section if needed -->
        <xxforms:variable name="current-control"
                          select="if ($control-name) then $body//*[@id = concat($control-name, '-control')] else ()"/>
        <xxforms:variable name="current-section-name"
                          select="if ($control-name) then $current-control/ancestor::fr:section[1]/(if (@context) then @context else substring-before(@bind, '-bind')) else $section-name"/>
        <xforms:action context="$model/xforms:bind[@id = 'fr-form-binds']">
            <xforms:action if="not(xforms:bind[@nodeset = $current-section-name])">
                <xforms:insert context="." nodeset="xforms:bind" origin="instance('fb-bind-template')"/>
                <xxforms:variable name="bind" select="xforms:bind[last()]" as="element(xforms:bind)"/>
                <xforms:setvalue ref="$bind/@id" value="concat($current-section-name, '-bind')"/>
                <xforms:setvalue ref="$bind/@nodeset" value="$current-section-name"/>
            </xforms:action>
        </xforms:action>

        <xforms:action if="$control-name">
            <!-- Insert bind for control if needed -->
            <xxforms:variable name="current-bind-id" select="concat($control-name, '-bind')"/>
            <xforms:action context="$model/xforms:bind[@id = 'fr-form-binds']/xforms:bind[@nodeset = $current-section-name]">
                <xforms:action if="not(xforms:bind[@id = $current-bind-id])">
                    <xforms:insert context="." nodeset="xforms:bind" origin="instance('fb-bind-template')"/>
                    <xxforms:variable name="bind" select="xforms:bind[last()]" as="element(xforms:bind)"/>
                    <xforms:setvalue ref="$bind/@id" value="$current-bind-id"/>
                    <xforms:insert context="$bind" origin="xxforms:attribute('name', $control-name)"/>
                    <xforms:setvalue ref="$bind/@nodeset" value="$control-name"/>
                </xforms:action>
            </xforms:action>
        </xforms:action>
    </xforms:action>

    <!-- TODO: Use this once OF supports custom XPath functions -->
    <!--<xforms:function name="fb:get-section-name" as="xs:string">-->
        <!--<xforms:param name="section" as="element(fr:section)"/>-->
        <!--<xforms:return select="if ($section/@context) then $section/@context else substring-before($section/@bind, '-bind')"/>-->
    <!--</xforms:function>-->

    <!-- Schema upload dialog -->
    <xforms:instance id="fb-schema-upload-instance">
        <validation>
            <schema-uri filename="" mediatype="" size=""/>
            <schema>
                <!-- Content will be like this -->
                <!--<xs:schema>-->
                    <!--...-->
                <!--</xs:schema>-->
            </schema>
            <temp-type/>
        </validation>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-schema-upload-instance')">
        <xforms:bind nodeset="temp-type" readonly="true()"/>
    </xforms:bind>

    <!-- Submission to upload the schema -->
    <xforms:submission id="fb-schema-upload-submission" ref="instance('fb-schema-upload-instance')"
                       method="post" replace="none" resource="test:"/>

    <!-- Submission to load initial components-->
    <!-- TODO: should load components based on app config? -->
    <xforms:submission id="fb-load-components" serialization="none"
                       method="get" resource="{xxforms:property('oxf.fb.components.uri.*.*')}"
                       replace="instance" instance="fb-components-instance"/>

    <xforms:instance id="fb-components-instance">
        <!-- This will contain the default component available for the currently edited form -->
        <xbl:xbl/>
    </xforms:instance>

    <!-- Template for outer bind -->
    <xforms:instance id="fb-bind-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xhtml xs xsi ev xi xxi xxforms fr fb saxon xbl exforms">
        <xforms:bind id="fr-form-binds" nodeset="."/>
    </xforms:instance>

    <xforms:bind nodeset="instance('fb-variables')">
        <xforms:bind nodeset="new-language-trigger" readonly="normalize-space(../new-language) = ''"/>
    </xforms:bind>

    <xxforms:variable name="variables" select="instance('fb-variables')"/>
    <xxforms:variable name="next-section-id" select="$variables/next-section-id"/>
    <xxforms:variable name="next-control-id" select="$variables/next-control-id"/>

    <!-- Compute the next section id -->
    <xforms:action ev:event="fb-compute-section-id">
        <!-- Initialize with count of existing sections (we could as well start from 1) -->
        <xforms:setvalue if="$next-section-id = ''" ref="$next-section-id" value="count($body//fr:section)"/>
        <!-- Increment number until the id doesn't clash with the control id OR the element name -->
        <xforms:action while="$body//fr:section[@id = concat('section-', $next-section-id, '-section')]
                                or $form-instance/*[name() = concat('section-', $next-section-id)]">
            <xforms:setvalue ref="$next-section-id" value=". + 1"/>
        </xforms:action>
    </xforms:action>

    <!-- Compute the next control id -->
    <xforms:action ev:event="fb-compute-control-id">
        <!-- Initialize based on count of existing controls (we could as well start from 1) -->
        <xforms:setvalue if="$next-control-id = ''" ref="$next-control-id" value="count($body//*[ends-with(@id, '-control')]) + 1"/>
        <!-- Increment number until the id doesn't clash with the control id OR the element name -->
        <xforms:action while="$body//*[@id = concat('control-', $next-control-id, '-control')]
                                or $form-instance/*/*[name() = concat('control-', $next-control-id)]">
            <xforms:setvalue ref="$next-control-id" value=". + 1"/>
        </xforms:action>
    </xforms:action>

    <xforms:instance id="fb-section-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xs xsi ev xi xxi xxforms fb saxon xbl exforms">
        <fr:section id="" bind="">
            <xforms:label ref=""/>
            <xforms:help ref=""/>
            <fr:grid columns="1">
                <xhtml:tr>
                    <xhtml:td/>
                </xhtml:tr>
            </fr:grid>
        </fr:section>
    </xforms:instance>

    <xforms:instance id="fb-resource-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xhtml xforms xs xsi ev xi xxi xxforms fr fb saxon xbl exforms">
        <template>
            <label/>
            <hint/>
            <help/>
            <alert/>
        </template>
    </xforms:instance>

    <xforms:instance id="fb-grid-1-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xforms xs xsi ev xi xxi xxforms fb saxon xbl exforms">
        <fr:grid columns="1">
            <xhtml:tr>
                <xhtml:td/>
            </xhtml:tr>
        </fr:grid>
    </xforms:instance>

    <xforms:instance id="fb-lhha-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xhtml xs xsi ev xi xxi xxforms fr fb saxon xbl exforms">
        <xforms:input>
            <xforms:label ref=""/>
            <xforms:hint ref=""/>
            <xforms:help ref=""/>
            <xforms:alert ref="$fr-resources/detail/labels/alert"/>
        </xforms:input>
    </xforms:instance>

    <!-- Built-in controls -->
    <!-- TODO: create XBL-like control metadata for those -->
    <xforms:instance id="fb-controls-template" xxforms:readonly="true" xxforms:exclude-result-prefixes="pipeline xs xsi ev xi xxi fr fb saxon xbl exforms">
        <templates xmlns="">
            <template label="Single-Line Text">
                <xhtml:div class="input">
                    <xforms:input id="" ref="" incremental="true">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:input>
                </xhtml:div>
            </template>
            <template label="Multi-Line Text">
                <xhtml:div id="" class="textarea">
                    <xforms:textarea id="" ref="" incremental="true">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:textarea>
                </xhtml:div>
            </template>
            <template label="Date" image="/ops/images/xforms/calendar.png">
                <xhtml:div class="date-input">
                    <xforms:input id="" ref="" incremental="true">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:input>
                </xhtml:div>
            </template>
            <template label="Time" image="/apps/fr/style/images/silk/clock.png">
                <xhtml:div class="time-input">
                    <xforms:input id="" ref="" incremental="true">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:input>
                </xhtml:div>
            </template>
            <template label="Date and Time" image="/apps/fr/style/images/silk/clock_link.png">
                <xhtml:div class="dateTime-input">
                    <xforms:input id="" ref="" incremental="true">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:input>
                </xhtml:div>
            </template>
            <template label="Dropdown">
                <xhtml:div class="dropdown">
                    <xforms:select1 id="" appearance="minimal" ref="">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                        <xforms:item>
                            <xforms:label>[Select...]</xforms:label>
                            <xforms:value/>
                        </xforms:item>
                        <xforms:itemset nodeset="">
                            <xforms:label ref="label"/>
                            <xforms:value ref="value"/>
                        </xforms:itemset>
                    </xforms:select1>
                </xhtml:div>
            </template>
            <template label="Radio Buttons">
                <xhtml:div class="radio">
                    <xforms:select1 id="" appearance="full" ref="">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                        <xforms:itemset nodeset="">
                            <xforms:label ref="label"/>
                            <xforms:value ref="value"/>
                        </xforms:itemset>
                    </xforms:select1>
                </xhtml:div>
            </template>
            <template label="Single list box">
                <xhtml:div class="listbox">
                    <xforms:select1 id="" appearance="compact" ref="">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                        <xforms:itemset nodeset="">
                            <xforms:label ref="label"/>
                            <xforms:value ref="value"/>
                        </xforms:itemset>
                    </xforms:select1>
                </xhtml:div>
            </template>
            <template label="Checkboxes">
                <xhtml:div class="checkbox">
                    <xforms:select id="" appearance="full" ref="">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                        <xforms:itemset nodeset="">
                            <xforms:label ref="label"/>
                            <xforms:value ref="value"/>
                        </xforms:itemset>
                    </xforms:select>
                </xhtml:div>
            </template>
            <template label="Multi list box" image="/forms/orbeon/builder/images/listbox.png">
                <xhtml:div class="listbox-multiple">
                    <xforms:select id="" appearance="compact" ref="">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                        <xforms:itemset nodeset="">
                            <xforms:label ref="label"/>
                            <xforms:value ref="value"/>
                        </xforms:itemset>
                    </xforms:select>
                </xhtml:div>
            </template>
            <template label="Text Output" image="/apps/fr/style/images/silk/text_align_left.png">
                <xhtml:div class="output">
                    <xforms:output id="" ref="">
                        <xforms:label ref=""/>
                        <xforms:help ref=""/>
                        <!-- No hint? -->
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:output>
                </xhtml:div>
            </template>
            <template label="Button">
                <xhtml:div class="button">
                    <xforms:trigger id="">
                        <xforms:label ref=""/>
                        <xforms:help ref=""/>
                        <!-- No hint? -->
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:trigger>
                </xhtml:div>
            </template>
            <template label="Image" image="/apps/fr/style/images/silk/images.png">
                <xhtml:div class="image">
                    <xforms:output id="" bind="" mediatype="image/*" class="fr-attachment">
                        <xforms:label ref=""/>
                        <xforms:help ref=""/>
                        <!-- No hint? -->
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                    </xforms:output>
                </xhtml:div>
            </template>
            <template label="Attachment" image="/apps/fr/style/images/silk/attach.png">
                <xhtml:div class="upload">
                    <xforms:upload id="" ref="" class="fr-attachment">
                        <xforms:label ref=""/>
                        <xforms:hint ref=""/>
                        <xforms:help ref=""/>
                        <xforms:alert ref="$fr-resources/detail/labels/alert"/>
                        <xforms:filename ref="@filename"/>
                        <xforms:mediatype ref="@mediatype"/>
                        <xxforms:size ref="@size"/>
                    </xforms:upload>
                </xhtml:div>
            </template>
        </templates>
    </xforms:instance>

</xforms:model>
